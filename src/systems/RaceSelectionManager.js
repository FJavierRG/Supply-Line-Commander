// ===== GESTOR DE SELECCI√ìN DE RAZA =====
// Maneja la UI de selecci√≥n de raza antes de iniciar la partida

import { getAllRaces, getRaceConfig } from '../config/races.js';

export class RaceSelectionManager {
    constructor(game) {
        this.game = game;
        this.isVisible = false;
        this.selectedRace = null;
        this.races = getAllRaces();
        
        // Layout de la UI
        this.layout = {
            overlay: { x: 0, y: 0, w: 1920, h: 1080 }, // Pantalla completa
            container: { x: 0, y: 0, w: 800, h: 600 }, // Contenedor centrado
            title: { x: 0, y: 50, w: 800, h: 80 },
            racesContainer: { x: 0, y: 150, w: 800, h: 350 },
            raceButton: { w: 400, h: 150, gap: 80 }, // Botones m√°s anchos y menos separados
            confirmButton: { x: 0, y: 520, w: 250, h: 60 }
        };
        
        // Hitboxes para interacci√≥n
        this.hitRegions = [];
        
        // Inicializar sin raza seleccionada por defecto
        this.selectedRace = null;
    }
    
    /**
     * Muestra la pantalla de selecci√≥n de raza
     */
    show() {
        this.isVisible = true;
        this.updateHitRegions();
        console.log('üèõÔ∏è Pantalla de selecci√≥n de raza mostrada');
    }
    
    /**
     * Oculta la pantalla de selecci√≥n de raza
     */
    hide() {
        this.isVisible = false;
        this.hitRegions = [];
        console.log('üèõÔ∏è Pantalla de selecci√≥n de raza oculta');
    }
    
    /**
     * Selecciona una raza
     * @param {string} raceId - ID de la raza a seleccionar
     */
    selectRace(raceId) {
        const raceConfig = getRaceConfig(raceId);
        if (raceConfig) {
            this.selectedRace = raceId;
            console.log(`üèõÔ∏è Raza seleccionada: ${raceConfig.name}`);
        }
    }
    
    /**
     * M√©todo llamado desde NetworkManager cuando se confirma la selecci√≥n de raza
     * @param {string} raceId - ID de la raza confirmada por el servidor
     */
    onRaceSelected(raceId) {
        this.selectedRace = raceId;
        console.log(`üèõÔ∏è Raza confirmada por servidor: ${raceId}`);
        
        // Actualizar el juego local
        if (this.game.onRaceSelected) {
            this.game.onRaceSelected(raceId);
        }
    }
    
    /**
     * Confirma la selecci√≥n de raza y contin√∫a con el juego
     */
    confirmSelection() {
        if (!this.selectedRace) {
            console.log('‚ö†Ô∏è Debes seleccionar una raza antes de continuar');
            return;
        }
        
        console.log(`üèõÔ∏è Confirmando selecci√≥n de raza: ${this.selectedRace}`);
        
        // Notificar al juego sobre la selecci√≥n
        if (this.game.onRaceSelected) {
            this.game.onRaceSelected(this.selectedRace);
        }
        
        // Ocultar la pantalla de selecci√≥n
        this.hide();
    }
    
    /**
     * Actualiza las hitboxes para la interacci√≥n
     */
    updateHitRegions() {
        this.hitRegions = [];
        
        if (!this.isVisible) return;
        
        // Obtener dimensiones reales del canvas
        const canvasWidth = this.game.canvas.width;
        const canvasHeight = this.game.canvas.height;
        
        // Centrar el contenedor en la pantalla
        const centerX = canvasWidth / 2;
        const centerY = canvasHeight / 2;
        
        // Hitboxes de botones de raza en grid sim√©trico
        const totalWidth = (this.layout.raceButton.w * 2) + this.layout.raceButton.gap;
        const startX = centerX - totalWidth / 2;
        
        this.races.forEach((race, index) => {
            const col = index % 2; // 0 o 1
            const row = Math.floor(index / 2); // 0 o m√°s
            
            const buttonX = startX + (col * (this.layout.raceButton.w + this.layout.raceButton.gap));
            const buttonY = centerY - this.layout.raceButton.h / 2 + (row * (this.layout.raceButton.h + 30));
            
            this.hitRegions.push({
                id: `race_${race.id}`,
                x: buttonX,
                y: buttonY,
                w: this.layout.raceButton.w,
                h: this.layout.raceButton.h,
                type: 'race',
                raceId: race.id
            });
        });
        
        // Hitbox del bot√≥n de confirmar
        const confirmX = centerX - this.layout.confirmButton.w / 2;
        const confirmY = centerY + 250;
        
        this.hitRegions.push({
            id: 'confirm',
            x: confirmX,
            y: confirmY,
            w: this.layout.confirmButton.w,
            h: this.layout.confirmButton.h,
            type: 'confirm'
        });
    }
    
    /**
     * Maneja clicks en la UI
     */
    handleClick(mouseX, mouseY) {
        if (!this.isVisible) return false;
        
        // Buscar hitbox clickeada
        const clickedRegion = this.hitRegions.find(region => 
            mouseX >= region.x && mouseX <= region.x + region.w &&
            mouseY >= region.y && mouseY <= region.y + region.h
        );
        
        if (clickedRegion) {
            if (clickedRegion.type === 'race') {
                this.selectRace(clickedRegion.raceId);
                this.updateHitRegions(); // Actualizar hitboxes
                return true;
            }
            
            if (clickedRegion.type === 'confirm') {
                if (this.selectedRace) {
                    this.confirmSelection();
                } else {
                    console.log('‚ö†Ô∏è Debes seleccionar una raza antes de continuar');
                }
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * Renderiza la UI de selecci√≥n de raza
     */
    render(ctx) {
        // console.log(`üèõÔ∏è RaceSelectionManager.render() llamado - isVisible: ${this.isVisible}`);
        if (!this.isVisible) return;
        
        // console.log('üèõÔ∏è RaceSelectionManager.render() EJECUT√ÅNDOSE');
        this.updateHitRegions();
        
        // Obtener dimensiones reales del canvas
        const canvasWidth = ctx.canvas.width;
        const canvasHeight = ctx.canvas.height;
        
        // Centrar el contenedor en la pantalla
        const centerX = canvasWidth / 2;
        const centerY = canvasHeight / 2;
        
        // DEBUG: Log de dimensiones
        if (!this._debugLogged) {
            // console.log(`üèõÔ∏è RaceSelectionManager render: canvas=${canvasWidth}x${canvasHeight}, center=(${centerX}, ${centerY})`);
            this._debugLogged = true;
        }
        
        // CR√çTICO: Limpiar el canvas completamente antes de renderizar
        this.game.renderer.clear();
        
        // Renderizar overlay de fondo s√≥lido (no semi-transparente)
        this.renderOverlay(ctx, canvasWidth, canvasHeight);
        
        // Renderizar t√≠tulo
        this.renderTitle(ctx, centerX, centerY - 250);
        
        // Renderizar botones de raza en grid sim√©trico
        this.renderRaceButtons(ctx, centerX, centerY);
        
        // Renderizar bot√≥n de confirmar
        this.renderConfirmButton(ctx, centerX, centerY + 250);
        
        // DEBUG: Renderizar hitboxes (comentar cuando no sea necesario)
        // this.renderDebugHitboxes(ctx);
    }
    
    /**
     * Renderiza el overlay de fondo
     */
    renderOverlay(ctx, canvasWidth, canvasHeight) {
        ctx.save();
        ctx.fillStyle = '#1a1a1a'; // Fondo s√≥lido oscuro en lugar de semi-transparente
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
        ctx.restore();
    }
    
    /**
     * Renderiza el t√≠tulo
     */
    renderTitle(ctx, centerX, y) {
        ctx.save();
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 48px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Selecciona tu Naci√≥n', centerX, y);
        ctx.restore();
        
        // DEBUG: Log de renderizado del t√≠tulo
        if (!this._titleDebugLogged) {
            // console.log(`üèõÔ∏è T√≠tulo renderizado en: (${centerX}, ${y})`);
            this._titleDebugLogged = true;
        }
    }
    
    /**
     * Renderiza los botones de raza en grid sim√©trico
     */
    renderRaceButtons(ctx, centerX, centerY) {
        // Calcular posiciones para grid sim√©trico (2 columnas)
        const totalWidth = (this.layout.raceButton.w * 2) + this.layout.raceButton.gap;
        const startX = centerX - totalWidth / 2;
        
        this.races.forEach((race, index) => {
            const col = index % 2; // 0 o 1
            const row = Math.floor(index / 2); // 0 o m√°s
            
            const buttonX = startX + (col * (this.layout.raceButton.w + this.layout.raceButton.gap));
            const buttonY = centerY - this.layout.raceButton.h / 2 + (row * (this.layout.raceButton.h + 30));
            
            this.renderRaceButton(ctx, race, buttonX, buttonY, this.selectedRace === race.id);
        });
    }
    
    /**
     * Renderiza un bot√≥n de raza individual usando UIFrame
     */
    renderRaceButton(ctx, race, x, y, isSelected) {
        ctx.save();
        
        // Usar el sprite UIFrame del men√∫ principal
        const buttonSprite = this.game.assetManager.getSprite('ui-menu-button');
        
        if (buttonSprite) {
            // Renderizar sprite del bot√≥n
            ctx.drawImage(buttonSprite, x, y, this.layout.raceButton.w, this.layout.raceButton.h);
            
            // Overlay de selecci√≥n si est√° seleccionado
            if (isSelected) {
                ctx.fillStyle = 'rgba(46, 204, 113, 0.3)'; // Verde semi-transparente
                ctx.fillRect(x, y, this.layout.raceButton.w, this.layout.raceButton.h);
                
                // Borde de selecci√≥n
                ctx.strokeStyle = '#2ecc71';
                ctx.lineWidth = 4;
                ctx.strokeRect(x, y, this.layout.raceButton.w, this.layout.raceButton.h);
            }
        } else {
            // Fallback si no hay sprite
            if (isSelected) {
                ctx.fillStyle = '#2ecc71';
                ctx.strokeStyle = '#27ae60';
                ctx.lineWidth = 4;
            } else {
                ctx.fillStyle = '#34495e';
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 2;
            }
            
            ctx.fillRect(x, y, this.layout.raceButton.w, this.layout.raceButton.h);
            ctx.strokeRect(x, y, this.layout.raceButton.w, this.layout.raceButton.h);
        }
        
        // Texto del nombre de la raza
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 28px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(race.name, x + this.layout.raceButton.w / 2, y + 40);
        
        // Descripci√≥n de la raza
        ctx.font = '18px Arial';
        ctx.fillStyle = '#ecf0f1';
        ctx.fillText(race.description, x + this.layout.raceButton.w / 2, y + 75);
        
        // Lista de edificios disponibles (SOLO VISUAL - FALLBACK)
        ctx.font = '16px Arial';
        ctx.fillStyle = '#bdc3c7';
        // ‚ö†Ô∏è DEPRECATED: race.buildings y race.consumables movidos al servidor
        // Usar fallback seguro para informaci√≥n visual
        const buildingsText = `Edificios: Disponibles`;
        const consumablesText = `Consumibles: Disponibles`;
        ctx.fillText(buildingsText, x + this.layout.raceButton.w / 2, y + 105);
        ctx.fillText(consumablesText, x + this.layout.raceButton.w / 2, y + 125);
        
        ctx.restore();
    }
    
    /**
     * Renderiza el bot√≥n de confirmar usando UIFrame
     */
    renderConfirmButton(ctx, centerX, y) {
        const buttonX = centerX - this.layout.confirmButton.w / 2;
        const isEnabled = this.selectedRace !== null;
        
        ctx.save();
        
        // Usar el sprite UIFrame del men√∫ principal
        const buttonSprite = this.game.assetManager.getSprite('ui-menu-button');
        
        if (buttonSprite) {
            // Renderizar sprite del bot√≥n
            ctx.drawImage(buttonSprite, buttonX, y, this.layout.confirmButton.w, this.layout.confirmButton.h);
            
            // Overlay de deshabilitado si no est√° habilitado
            if (!isEnabled) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(buttonX, y, this.layout.confirmButton.w, this.layout.confirmButton.h);
            }
        } else {
            // Fallback si no hay sprite
            if (isEnabled) {
                ctx.fillStyle = '#e74c3c';
                ctx.strokeStyle = '#c0392b';
                ctx.lineWidth = 3;
            } else {
                ctx.fillStyle = '#7f8c8d';
                ctx.strokeStyle = '#95a5a6';
                ctx.lineWidth = 2;
            }
            
            ctx.fillRect(buttonX, y, this.layout.confirmButton.w, this.layout.confirmButton.h);
            ctx.strokeRect(buttonX, y, this.layout.confirmButton.w, this.layout.confirmButton.h);
        }
        
        // Texto del bot√≥n
        ctx.fillStyle = isEnabled ? '#ffffff' : '#bdc3c7';
        ctx.font = 'bold 24px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        const buttonText = isEnabled ? 'Iniciar Misi√≥n' : 'Elegir naci√≥n';
        ctx.fillText(buttonText, centerX, y + this.layout.confirmButton.h / 2);
        ctx.restore();
    }
    
    /**
     * DEBUG: Renderiza las hitboxes para visualizar su posici√≥n
     */
    renderDebugHitboxes(ctx) {
        ctx.strokeStyle = '#00ff00';
        ctx.lineWidth = 2;
        ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
        
        this.hitRegions.forEach(region => {
            ctx.strokeRect(region.x, region.y, region.w, region.h);
            ctx.fillRect(region.x, region.y, region.w, region.h);
            
            // Texto con el ID
            ctx.fillStyle = '#ffffff';
            ctx.font = '10px Arial';
            ctx.fillText(region.id, region.x + 5, region.y + 15);
            ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
        });
    }
}
