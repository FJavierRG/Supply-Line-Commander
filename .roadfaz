# ğŸ”§ PLAN DE MODULARIZACIÃ“N: GameStateManager

**Archivo actual:** `server/game/GameStateManager.js` (1501 lÃ­neas)  
**Objetivo:** Reducir a ~300 lÃ­neas mediante extracciÃ³n de managers especializados  
**Fecha:** 2024

---

## ğŸ“Š ANÃLISIS DEL ARCHIVO ACTUAL

### TamaÃ±o
- **Total:** 1501 lÃ­neas
- **MÃ©todo `update()`:** ~340 lÃ­neas (22% del archivo)
- **Funciones de serializaciÃ³n:** ~200 lÃ­neas
- **Funciones de gestiÃ³n:** ~500 lÃ­neas

### Responsabilidades actuales (demasiadas)
1. âœ… GestiÃ³n de helicÃ³pteros
2. âœ… SerializaciÃ³n de estado
3. âœ… OptimizaciÃ³n de red
4. âœ… GestiÃ³n de razas
5. âœ… Movimiento de convoyes
6. âœ… Consumo de supplies
7. âœ… Sistema de inversiones
8. âœ… CÃ¡lculo de territorio
9. âœ… OrquestaciÃ³n de sistemas

---

## ğŸ¯ PLAN DE MODULARIZACIÃ“N (5 FASES)

### **FASE 1: Extraer Managers Existentes** (Ya completado âœ…)
- `BuildHandler` â†’ `server/game/handlers/BuildHandler.js`
- `ConvoyHandler` â†’ `server/game/handlers/ConvoyHandler.js`
- `CombatHandler` â†’ `server/game/handlers/CombatHandler.js`

---

### **FASE 2: Crear Managers Especializados**

#### **2.1 HelicopterManager**
**Archivo:** `server/game/managers/HelicopterManager.js`  
**Responsabilidad:** CreaciÃ³n, actualizaciÃ³n y llegadas de helicÃ³pteros

```javascript
class HelicopterManager {
    constructor(gameState) {
        this.gameState = gameState;
    }
    
    createHelicopter(team, nodeId) {
        // LÃ­nea 382 de GameStateManager
    }
    
    update(dt) {
        // LÃ­nea 413 de GameStateManager
    }
    
    handleArrival(heli, toNode) {
        // LÃ­nea 444 de GameStateManager
    }
}
```

**MÃ©todos a extraer:**
- `createHelicopter()` (lÃ­nea 382)
- `updateHelicopters()` (lÃ­nea 413)
- `handleHelicopterArrival()` (lÃ­nea 444)

**EstimaciÃ³n:** 150 lÃ­neas

---

#### **2.2 StateSerializer**
**Archivo:** `server/game/managers/StateSerializer.js`  
**Responsabilidad:** SerializaciÃ³n de estado para envÃ­o a clientes

```javascript
class StateSerializer {
    constructor(gameState) {
        this.gameState = gameState;
    }
    
    serializeNodes() {
        // LÃ­nea 593
    }
    
    serializeConvoys() {
        // LÃ­nea 689
    }
    
    serializeHelicopters() {
        // LÃ­nea 811
    }
    
    serializeAll() {
        // Combina todo
    }
}
```

**MÃ©todos a extraer:**
- `serializeNodes()` (lÃ­nea 593)
- `hasNodeSignificantChanges()` (lÃ­nea 531)
- `serializeConvoys()` (lÃ­nea 689)
- `hasConvoySignificantChanges()` (lÃ­nea 664)
- `serializeAllNodes()` (lÃ­nea 717)
- `serializeAllConvoys()` (lÃ­nea 785)
- `serializeHelicopters()` (lÃ­nea 811)
- `serializeAllHelicopters()` (lÃ­nea 828)

**EstimaciÃ³n:** 250 lÃ­neas

---

#### **2.3 OptimizationTracker**
**Archivo:** `server/game/managers/OptimizationTracker.js`  
**Responsabilidad:** Tracking de cambios para optimizaciÃ³n de red

```javascript
class OptimizationTracker {
    constructor(gameState) {
        this.gameState = gameState;
        this.lastSentState = null;
        this.lastNodeStates = new Map();
        this.lastConvoyStates = new Map();
    }
    
    hasSignificantChanges(currentState) {
        // LÃ­nea 1273
    }
    
    cleanupNodeTracking() {
        // LÃ­nea 1250
    }
    
    cleanupConvoyTracking() {
        // LÃ­nea 1260
    }
}
```

**MÃ©todos a extraer:**
- `hasNodeSignificantChanges()` (lÃ­nea 531)
- `hasConvoySignificantChanges()` (lÃ­nea 664)
- `hasSignificantChanges()` (lÃ­nea 1273)
- `cleanupNodeTracking()` (lÃ­nea 1250)
- `cleanupConvoyTracking()` (lÃ­nea 1260)

**EstimaciÃ³n:** 120 lÃ­neas

---

#### **2.4 TerritoryCalculator**
**Archivo:** `server/game/managers/TerritoryCalculator.js`  
**Responsabilidad:** CÃ¡lculos de territorio y fronteras

```javascript
class TerritoryCalculator {
    constructor(gameState) {
        this.gameState = gameState;
    }
    
    isInTeamTerritory(x, team) {
        // LÃ­nea 1402
    }
}
```

**MÃ©todos a extraer:**
- `isInTeamTerritory()` (lÃ­nea 1402)

**EstimaciÃ³n:** 50 lÃ­neas

---

### **FASE 3: Extraer LÃ³gica de Raza**

#### **3.1 RaceManager**
**Archivo:** `server/game/managers/RaceManager.js`  
**Responsabilidad:** GestiÃ³n de razas y mecÃ¡nicas especiales

```javascript
class RaceManager {
    constructor(gameState) {
        this.gameState = gameState;
    }
    
    getPlayerRaceConfig(team) {
        // LÃ­nea 91
    }
    
    canPlayerUseFOBs(team) {
        // LÃ­nea 101
    }
    
    getPlayerTransportSystem(team) {
        // LÃ­nea 111
    }
    
    getValidRoutesForPlayer(fromType, team) {
        // LÃ­nea 122
    }
    
    configureNodeForRace(node, team) {
        // LÃ­nea 142
    }
    
    getInitialVehiclesForRace(team, nodeType) {
        // LÃ­nea 166
    }
}
```

**MÃ©todos a extraer:**
- `getPlayerRaceConfig()` (lÃ­nea 91)
- `canPlayerUseFOBs()` (lÃ­nea 101)
- `getPlayerTransportSystem()` (lÃ­nea 111)
- `getValidRoutesForPlayer()` (lÃ­nea 122)
- `configureNodeForRace()` (lÃ­nea 142)
- `getInitialVehiclesForRace()` (lÃ­nea 166)
- `setPlayerRace()` (lÃ­nea 218, 1496)
- `getPlayerRace()` (lÃ­nea 233, 1487)

**EstimaciÃ³n:** 200 lÃ­neas

---

### **FASE 4: Simplificar mÃ©todo `update()`**

#### **4.1 ConvoyMovementManager**
**Archivo:** `server/game/managers/ConvoyMovementManager.js`  
**Responsabilidad:** Movimiento y llegadas de convoyes

```javascript
class ConvoyMovementManager {
    constructor(gameState) {
        this.gameState = gameState;
    }
    
    update(dt) {
        // LÃ­neas 960-1105 (~145 lÃ­neas)
        // - Actualizar progress
        // - PenalizaciÃ³n por sabotaje
        // - Bonus de EngineerCenter
        // - Manejo de ambulancias
        // - Regreso a origen
    }
}
```

**MÃ©todos a extraer:**
- LÃ³gica de actualizaciÃ³n de convoyes (lÃ­neas 960-1105)

**EstimaciÃ³n:** 180 lÃ­neas

---

#### **4.2 SupplyManager**
**Archivo:** `server/game/managers/SupplyManager.js`  
**Responsabilidad:** Consumo de supplies en frentes

```javascript
class SupplyManager {
    constructor(gameState) {
        this.gameState = gameState;
    }
    
    update(dt) {
        // LÃ­neas 1107-1120
    }
}
```

**MÃ©todos a extraer:**
- Consumo de supplies en frentes (lÃ­neas 1107-1120)

**EstimaciÃ³n:** 30 lÃ­neas

---

#### **4.3 InvestmentManager**
**Archivo:** `server/game/managers/InvestmentManager.js`  
**Responsabilidad:** Sistema de inversiones IntelRadio

```javascript
class InvestmentManager {
    constructor(gameState) {
        this.gameState = gameState;
    }
    
    update(dt) {
        // LÃ­neas 1122-1140
    }
}
```

**MÃ©todos a extraer:**
- Sistema de inversiÃ³n IntelRadio (lÃ­neas 1122-1140)

**EstimaciÃ³n:** 40 lÃ­neas

---

### **FASE 5: Refactorizar GameStateManager**

#### **5.1 Estructura final**
```javascript
// GameStateManager.js (300 lÃ­neas)
class GameStateManager {
    constructor(room) {
        this.room = room;
        this.nodes = [];
        this.convoys = [];
        this.currency = {...};
        this.playerRaces = {...};
        
        // Managers
        this.raceManager = new RaceManager(this);
        this.helicopterManager = new HelicopterManager(this);
        this.convoyMovementManager = new ConvoyMovementManager(this);
        this.supplyManager = new SupplyManager(this);
        this.investmentManager = new InvestmentManager(this);
        this.stateSerializer = new StateSerializer(this);
        this.optimizationTracker = new OptimizationTracker(this);
        this.territoryCalculator = new TerritoryCalculator(this);
        
        // Sistemas existentes
        this.medicalSystem = new MedicalSystemServer(this);
        this.frontMovement = new FrontMovementSystemServer(this);
        this.abandonmentSystem = new AbandonmentSystem(this);
        this.droneSystem = new DroneSystemServer(this);
        this.territory = new TerritorySystemServer(this);
        
        // Handlers
        this.buildHandler = new BuildHandler(this);
        this.convoyHandler = new ConvoyHandler(this);
        this.combatHandler = new CombatHandler(this);
        
        // Sistemas de actualizaciÃ³n
        this.currencySystem = new CurrencySystem(this);
        this.constructionSystem = new ConstructionSystem(this);
        this.effectsSystem = new EffectsSystem(this);
    }
    
    update(dt) {
        // Countdown
        if (!this.gameStarted) {
            return this.handleCountdown(dt);
        }
        
        // Audio timers
        this.updateAudioTimers(dt);
        
        // Actualizar sistemas
        this.currencySystem.updateCurrency(dt);
        this.constructionSystem.updateConstructions(dt);
        this.convoyMovementManager.update(dt);
        this.supplyManager.update(dt);
        this.investmentManager.update(dt);
        this.abandonmentSystem.checkAbandonmentConditions();
        this.abandonmentSystem.update(dt);
        this.helicopterManager.update(dt);
        this.medicalSystem.update(dt);
        
        // Movimiento de frentes (puede retornar victoria)
        const victoryResult = this.frontMovement.update(dt);
        if (victoryResult) {
            return this.handleVictory(victoryResult);
        }
        
        // Sistema de territorio
        this.territory.update(dt);
        this.territory.updateAbandonmentProgress(dt);
        
        // Actualizar drones
        const droneResult = this.droneSystem.update(dt);
        this.handleDroneResult(droneResult);
        
        // Limpiar entidades destruidas
        this.cleanupDestroyedEntities();
        
        // Serializar y retornar estado
        return this.stateSerializer.serialize();
    }
    
    // MÃ©todos pÃºblicos delegados
    getPlayerRaceConfig(team) {
        return this.raceManager.getPlayerRaceConfig(team);
    }
    
    canPlayerUseFOBs(team) {
        return this.raceManager.canPlayerUseFOBs(team);
    }
    
    isInTeamTerritory(x, team) {
        return this.territoryCalculator.isInTeamTerritory(x, team);
    }
    
    // ... resto de mÃ©todos delegados
}
```

---

## ğŸ“… PLAN DE MIGRACIÃ“N (4 SEMANAS)

### **Semana 1: Fases 1-2**
- [ ] Crear `HelicopterManager.js`
- [ ] Migrar cÃ³digo de helicÃ³pteros
- [ ] Crear `StateSerializer.js`
- [ ] Migrar cÃ³digo de serializaciÃ³n
- [ ] Crear `OptimizationTracker.js`
- [ ] Migrar cÃ³digo de optimizaciÃ³n
- [ ] Crear `TerritoryCalculator.js`
- [ ] Migrar cÃ³digo de territorio
- [ ] **Tests:** Verificar que todo funciona igual

### **Semana 2: Fase 3**
- [ ] Crear `RaceManager.js`
- [ ] Migrar cÃ³digo de razas
- [ ] Actualizar referencias en GameStateManager
- [ ] **Tests:** Verificar mecÃ¡nicas de raza

### **Semana 3: Fase 4**
- [ ] Crear `ConvoyMovementManager.js`
- [ ] Migrar lÃ³gica de convoyes del mÃ©todo `update()`
- [ ] Crear `SupplyManager.js`
- [ ] Migrar lÃ³gica de supplies
- [ ] Crear `InvestmentManager.js`
- [ ] Migrar lÃ³gica de inversiones
- [ ] **Tests:** Verificar movimientos y mecÃ¡nicas

### **Semana 4: Fase 5**
- [ ] Refactorizar mÃ©todo `update()` en GameStateManager
- [ ] Simplificar GameStateManager (objetivo: 300 lÃ­neas)
- [ ] Limpiar imports
- [ ] Documentar cada manager
- [ ] **Tests finales:** Partida completa end-to-end

---

## âœ… RESULTADO FINAL

### **Estructura de archivos**
```
server/game/
â”œâ”€â”€ GameStateManager.js          (300 lÃ­neas - orquestador)
â”œâ”€â”€ handlers/
â”‚   â”œâ”€â”€ BuildHandler.js          âœ… (296 lÃ­neas)
â”‚   â”œâ”€â”€ ConvoyHandler.js         âœ… (369 lÃ­neas)
â”‚   â””â”€â”€ CombatHandler.js         âœ… (155 lÃ­neas)
â”œâ”€â”€ managers/
â”‚   â”œâ”€â”€ RaceManager.js           ğŸ†• (200 lÃ­neas)
â”‚   â”œâ”€â”€ HelicopterManager.js     ğŸ†• (150 lÃ­neas)
â”‚   â”œâ”€â”€ ConvoyMovementManager.js ğŸ†• (180 lÃ­neas)
â”‚   â”œâ”€â”€ SupplyManager.js         ğŸ†• (30 lÃ­neas)
â”‚   â”œâ”€â”€ InvestmentManager.js     ğŸ†• (40 lÃ­neas)
â”‚   â”œâ”€â”€ StateSerializer.js       ğŸ†• (250 lÃ­neas)
â”‚   â”œâ”€â”€ OptimizationTracker.js   ğŸ†• (120 lÃ­neas)
â”‚   â””â”€â”€ TerritoryCalculator.js   ğŸ†• (50 lÃ­neas)
â””â”€â”€ systems/
    â”œâ”€â”€ CurrencySystem.js        âœ… (51 lÃ­neas)
    â”œâ”€â”€ ConstructionSystem.js    âœ… (31 lÃ­neas)
    â””â”€â”€ EffectsSystem.js         âœ… (34 lÃ­neas)
```

### **Ventajas**
1. âœ… **Mantenibilidad:** Cada manager tiene una sola responsabilidad
2. âœ… **Testabilidad:** FÃ¡cil testear managers individualmente
3. âœ… **Legibilidad:** GameStateManager queda como orquestador limpio
4. âœ… **Escalabilidad:** FÃ¡cil aÃ±adir nuevos managers sin tocar GameStateManager
5. âœ… **ReutilizaciÃ³n:** Managers pueden usarse en otros contextos

### **MÃ©tricas**
- **Antes:** 1 archivo de 1501 lÃ­neas
- **DespuÃ©s:** 11 archivos especializados
  - GameStateManager: 300 lÃ­neas (80% reducciÃ³n)
  - Managers: ~1000 lÃ­neas distribuidas en 8 archivos
  - Total: ~1300 lÃ­neas (ligera reducciÃ³n por eliminar duplicaciÃ³n)

---

## ğŸš€ SIGUIENTE PASO

**Â¿Comenzamos con la Fase 1?**
